<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>社區散步友善地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const map = L.map('map').setView([25.0330, 121.5654], 16); // 台北市中心

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // 各類地標查詢條件
    const categories = {
      water: 'node["amenity"="drinking_water"](around:RADIUS,LAT,LON);',
      convenience: `
        node["shop"="convenience"](around:RADIUS,LAT,LON);
        node["shop"="supermarket"]["brand"="Simple Mart"](around:RADIUS,LAT,LON);
      `,
      market: 'node["amenity"="marketplace"](around:RADIUS,LAT,LON);',
      park: 'way["leisure"="park"](around:RADIUS,LAT,LON);',
      toilet: `
        node["amenity"="toilets"](around:RADIUS,LAT,LON);
        node["toilets"="yes"](around:RADIUS,LAT,LON);
        way["toilets"="yes"](around:RADIUS,LAT,LON);
      `
    };

    // icon 設定
    const icons = {
      water: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/427/427735.png', iconSize:[30,30]}),
      convenience: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', iconSize:[30,30]}),
      market: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3076/3076098.png', iconSize:[30,30]}),
      park: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/427/427735.png', iconSize:[30,30]}),
      toilet: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/482/482946.png', iconSize:[30,30]})
    };

    // 搜尋地標
    function searchAmenities(lat, lon, radius=500) {
      for (const [type, query] of Object.entries(categories)) {
        const fullQuery = `
          [out:json];
          (
            ${query.replace(/LAT/g, lat).replace(/LON/g, lon).replace(/RADIUS/g, radius)}
          );
          out center;
        `;

        fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          body: fullQuery
        })
        .then(res => res.json())
        .then(data => {
          data.elements.forEach(el => {
            const latlng = el.type==="node" ? [el.lat, el.lon] : [el.center.lat, el.center.lon];
            let matchedType=null;
            if(el.tags){
              if(el.tags.amenity==="drinking_water") matchedType="water";
              else if(el.tags.shop==="convenience") matchedType="convenience";
              else if(el.tags.shop==="supermarket" && el.tags.brand==="Simple Mart") matchedType="convenience"; // ✅ 美廉社
              else if(el.tags.amenity==="marketplace") matchedType="market";
              else if(el.tags.leisure==="park") matchedType="park";
              else if(el.tags.amenity==="toilets" || el.tags.toilets==="yes") matchedType="toilet";
            }
            if(matchedType){
              L.marker(latlng,{icon:icons[matchedType]})
                .addTo(map)
                .bindPopup(el.tags.name || matchedType);
            }
          });
        })
        .catch(err => console.error("Overpass error:", err));
      }
    }

    // 取得目前位置
    map.locate({setView:true, maxZoom:16});
    map.on('locationfound', e=>{
      L.marker(e.latlng, {icon:L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/1946/1946429.png",iconSize:[30,30]})})
        .addTo(map).bindPopup("你在這裡");
      searchAmenities(e.latitude, e.longitude, 800);
    });
  </script>
</body>
</html>
