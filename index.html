<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>社區散步友善地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .controls {
      position:absolute; top:10px; left:10px; background:white;
      padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:1000;
      font-size:14px;
    }
    .controls label { display:block; margin:4px 0; }
    .controls select, .controls input, .controls button { margin-top:6px; }
    .controls button {
      padding:4px 8px; border-radius:6px; border:none;
      background:#4CAF50; color:white; cursor:pointer;
    }
  </style>
</head>
<body>
<div class="controls">
  <label><input type="checkbox" value="water"> 飲水機</label>
  <label><input type="checkbox" value="convenience"> 便利商店</label>
  <label><input type="checkbox" value="market"> 市場</label>
  <label><input type="checkbox" value="park"> 公園</label>
  <label><input type="checkbox" value="toilet"> 廁所</label>
  <label>搜尋半徑 (公尺)：<input type="number" id="radiusInput" value="500" min="100" step="100"></label>
  <button id="searchBtn">搜尋附近</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const map = L.map("map", { zoomControl: false }).setView([25.033964,121.564468],15);
L.control.zoom({ position:"bottomright" }).addTo(map);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:'© OpenStreetMap' }).addTo(map);

const userIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/149/149071.png",
  iconSize:[40,40], iconAnchor:[20,40], popupAnchor:[0,-40]
});

const icons = {
  water:L.icon({ iconUrl:"https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/72x72/1f4a7.png", iconSize:[40,40]}),
  convenience:L.icon({ iconUrl:"https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/72x72/1f3ea.png", iconSize:[40,40]}),
  market:L.icon({ iconUrl:"https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/72x72/1f34e.png", iconSize:[40,40]}),
  park:L.icon({ iconUrl:"https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/72x72/1f333.png", iconSize:[40,40]}),
  toilet:L.icon({ iconUrl:"https://cdn.jsdelivr.net/gh/twitter/twemoji/assets/72x72/1f6be.png", iconSize:[40,40]})
};

let userMarker, userLat, userLon;
navigator.geolocation.watchPosition(pos=>{
  userLat = pos.coords.latitude;
  userLon = pos.coords.longitude;
  if(!userMarker){
    userMarker = L.marker([userLat,userLon],{icon:userIcon}).addTo(map).bindPopup("你在這裡 📍");
    map.setView([userLat,userLon],16);
  } else {
    userMarker.setLatLng([userLat,userLon]);
  }
}, err=>{ console.error("定位失敗：",err); });

const categories = {
  water:'node["amenity"="drinking_water"](around:RADIUS,LAT,LON);',
  convenience:'node["shop"="convenience"](around:RADIUS,LAT,LON);',
  market:'node["amenity"="marketplace"](around:RADIUS,LAT,LON);',
  park:'way["leisure"="park"](around:RADIUS,LAT,LON);',
  toilet:`
    node["amenity"="toilets"](around:RADIUS,LAT,LON);
    node["toilets"="yes"](around:RADIUS,LAT,LON);
    way["toilets"="yes"](around:RADIUS,LAT,LON);
  `
};

function buildOverpassQuery(lat, lon, radius, selections){
  if(!selections || selections.length===0) return null;
  let body='[out:json][timeout:25];(';
  for(const sel of selections){
    let frag = categories[sel];
    frag = frag.replace(/RADIUS/g,radius).replace(/LAT/g,lat).replace(/LON/g,lon);
    body += "\n"+frag;
  }
  body+='\n);out center;';
  return body;
}

let searchMarkers=[], routeLine;

document.getElementById("searchBtn").addEventListener("click", ()=>{
  if(!userMarker){ alert("尚未取得定位"); return; }
  const checked = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(c=>c.value);
  const radius = parseInt(document.getElementById("radiusInput").value)||500;
  const query = buildOverpassQuery(userLat,userLon,radius,checked);
  if(!query){ alert("請先選擇要搜尋的類別"); return; }

  searchMarkers.forEach(m=>map.removeLayer(m));
  searchMarkers=[];
  if(routeLine) map.removeLayer(routeLine);

  fetch("https://overpass-api.de/api/interpreter", {
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:"data="+encodeURIComponent(query)
  })
  .then(r=>r.json())
  .then(data=>{
    data.elements.forEach(el=>{
      let lat = el.lat || el.center?.lat;
      let lon = el.lon || el.center?.lon;
      if(!lat || !lon) return;

      let matchedType=null;
      if(el.tags){
        if(el.tags.amenity==="drinking_water") matchedType="water";
        else if(el.tags.shop==="convenience") matchedType="convenience";
        else if(el.tags.amenity==="marketplace") matchedType="market";
        else if(el.tags.leisure==="park") matchedType="park";
        else if(el.tags.amenity==="toilets") matchedType="toilet";
        else if(el.tags.toilets==="yes") matchedType="toilet"; // 🚾 公共設施內的廁所
      }

      // 公園取 center 避免導航錯誤
      if(matchedType==="park" && el.type==="way" && el.center){
        lat = el.center.lat;
        lon = el.center.lon;
      }

      const marker = L.marker([lat,lon],{icon:matchedType?icons[matchedType]:undefined}).addTo(map);
      let placeName = el.tags.name || (
        matchedType==="market" ? "市場 (未命名)" :
        matchedType==="toilet" ? "廁所" :
        matchedType||"地點"
      );
      if(matchedType==="market" && el.tags.name) placeName = el.tags.name + "市場";

      marker.bindTooltip(placeName,{permanent:true,direction:"top",offset:[0,-10],className:"place-label"});
      marker.bindPopup(`
        <b>${placeName}</b><br>
        類型: ${matchedType||"未知"}<br>
        <button onclick="routeTo(${lat},${lon})">導航</button>
      `);

      searchMarkers.push(marker);
    });
  })
  .catch(err=>{ console.error(err); alert("查詢失敗，請稍後再試"); });
});

window.routeTo=function(destLat,destLon){
  if(!userLat || !userLon){ alert("尚未取得使用者位置"); return; }
  if(routeLine) map.removeLayer(routeLine);

  const url = `https://router.project-osrm.org/route/v1/foot/${userLon},${userLat};${destLon},${destLat}?overview=full&geometries=geojson`;

  fetch(url).then(r=>r.json()).then(data=>{
    if(!data.routes || data.routes.length===0){ alert("無法規劃路線"); return; }
    const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    routeLine = L.polyline(coords,{color:"blue",weight:5}).addTo(map);
    map.fitBounds(routeLine.getBounds());
  }).catch(err=>{ console.error(err); alert("路線規劃失敗"); });
};
</script>
</body>
</html>
